import { injectable } from "tsyringe"
import type { IReadListDTO } from "arc/shared";
import {
  aggregationBuildCount,
  aggregationBuildPagination,
  aggregationBuildSortPipeline,
} from "@shared/utils/mongo.utils";

import type { {{pascalCase module_name}} } from "arc/{{camelCase module_name}}/entities";
import { {{pascalCase module_name}}Model } from "./{{camelCase module_name}}.schema.repository"

@injectable()
export class {{pascalCase module_name}}Repository {

  async create(params: { {{camelCase module_name}}: Omit<{{pascalCase module_name}}, "id"> }): Promise<{{pascalCase module_name}}> {
    const {{camelCase module_name}} = await {{pascalCase module_name}}Model.create(params)
    return {{camelCase module_name}}
  }

  async update(params: { id: string, {{camelCase module_name}}: Partial<Omit<{{pascalCase module_name}}, "_id">> }): Promise<{{pascalCase module_name}} | null> {
    const {{camelCase module_name}} = await {{pascalCase module_name}}Model.findOneAndUpdate({ _id: params.id }, params, { new: true })
    return {{camelCase module_name}} || null
  }

  async readOne(params: { id: string }): Promise<{{pascalCase module_name}} | null> {
    const {{camelCase module_name}} = await {{pascalCase module_name}}Model.findOne({ _id: params.id })
    return {{camelCase module_name}} || null
  }

  async delete(params: { id: string }): Promise<{{pascalCase module_name}}> {
    const {{camelCase module_name}} = await {{pascalCase module_name}}Model.updateOne({ _id: params.id }, { $set: { deletedAt: new Date() } })
    return {{camelCase module_name}}
  }

  async readList(params: IReadListDTO): Promise<{{pascalCase module_name}}[]> {
    const pipeline = []

    pipeline.push(...aggregationBuildPagination(params));
    pipeline.push(...aggregationBuildSortPipeline(params));

    return await {{pascalCase module_name}}Model.aggregate<{{pascalCase module_name}}>(pipeline)
  }

  async count(params: IReadListDTO): Promise<number> {
    const pipeline = []

    pipeline.push(...aggregationBuildCount());

    const [result] = await {{pascalCase module_name}}Model.aggregate(pipeline);

    return result?.count || 0
  }
}
